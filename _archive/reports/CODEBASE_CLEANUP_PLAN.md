# CODEBASE CLEANUP PLAN - nextsteps update 11

**Objective**: Remove all invalid scripts/references that use unrealistic entry logic
**Method**: Aggressive cleanup - when in doubt, delete
**Date**: 2026-01-13

---

## STEP 1: INVALID SCRIPTS TO DELETE/DEPRECATE

### Scripts Using ORB Edge Entry (INVALID)

#### 1. backtest_all_orbs_complete.py
- **Entry method**: `entry = orb_high` (LINE 124)
- **Status**: **DELETE**
- **Reason**: Generates complete_orb_sweep_results.csv with invalid RR=4.0 results
- **Replacement**: Use build_daily_features_v2.py instead

#### 2. backtest_worst_case_execution.py
- **Entry method**: `entry = orb_high` (LINE 115)
- **Status**: **DELETE**
- **Reason**: Already flagged in CRITICAL_ENTRY_PRICE_FINDINGS.md as flawed
- **Replacement**: None (deprecated concept)

#### 3. backtest_asia_prop_safe.py
- **Entry method**: Contains `entry = orb_high`
- **Status**: **DELETE**
- **Reason**: Invalid entry assumption
- **Replacement**: Use build_daily_features_v2.py for Asia ORBs

#### 4. backtest_asia_orbs_current.py
- **Entry method**: Contains `entry = orb_high`
- **Status**: **DELETE**
- **Reason**: Invalid entry assumption
- **Replacement**: Use build_daily_features_v2.py for Asia ORBs

#### 5. backtest_london_optimized.py
- **Entry method**: Contains `entry = orb_high`
- **Status**: **DELETE**
- **Reason**: Invalid entry assumption
- **Replacement**: Use build_daily_features_v2.py for London ORBs

### Legacy/Unclear Scripts

#### 6. backtest_legacy.py
- **Status**: **DELETE** (if exists)
- **Reason**: Name suggests outdated logic

#### 7. backtest_focused_winners.py
- **Status**: CHECK → If invalid entry, DELETE
- **Reason**: Unknown methodology

---

## STEP 2: VALID SCRIPTS TO KEEP

### Primary Source of Truth

#### 1. build_daily_features_v2.py (with --sl-mode half)
- **Entry method**: `entry_price = close` (LINE 192) ✓ VALID
- **Status**: **KEEP - PRIMARY SOURCE**
- **Generates**: daily_features_v2_half, v_orb_trades_half
- **RR tested**: 1.0 (default)

### Secondary Valid Scripts (for comparison/research)

#### 2. backtest_orb_exec_5mhalfsl_orbR.py
- **Entry method**: `entry_price = close` (LINE 192) ✓ VALID
- **Status**: **KEEP - VALID**
- **Generates**: orb_trades_5m_exec_orbr
- **RR tested**: 2.0

#### 3-12. backtest_orb_exec_* family (various configs)
- backtest_orb_exec_1m.py
- backtest_orb_exec_5m.py
- backtest_orb_exec_5mhalfsl.py
- backtest_orb_exec_1m_nofilters.py
- backtest_orb_exec_5m_nofilters.py
- backtest_orb_exec_5mhalfsl_nofilters.py
- backtest_orb_exec_5m_COMPARE.py
- backtest_orb_exec_5mhalfsl_COMPARE.py
- backtest_orb_exec_5m_nomax.py
- backtest_orb_exec_5mhalfsl_nomax.py

**Status**: **CHECK EACH** - If entry = close, KEEP. If entry = orb_edge, DELETE.
**Action**: Add runtime assertion banner to valid ones.

---

## STEP 3: INVALID DATA FILES TO PURGE

### CSV Files Generated by Invalid Scripts

#### 1. complete_orb_sweep_results.csv
- **Source**: backtest_all_orbs_complete.py (INVALID)
- **Status**: **RENAME → complete_orb_sweep_results_INVALID.csv**
- **Reason**: Contains RR=4.0 results with ORB edge entry

#### 2. canonical_session_parameters.csv
- **Source**: Copied from complete_orb_sweep_results.csv
- **Status**: **REQUIRES CORRECTION**
- **Action**: Replace night ORB rows (23:00, 00:30) with v_orb_trades_half values

### CSV Files to Keep (if from valid sources)

- asia_orb_backtest_current.csv: CHECK source
- results_*_by_session.csv: CHECK source
- session_reality_check_results.csv: CHECK source

**Rule**: If source unknown or invalid → DELETE

---

## STEP 4: DOCUMENTATION TO FIX

### Files Referencing RR=4.0 Night ORBs (INVALID)

#### 1. STRATEGY_HIERARCHY_FINAL.md
- **Line 12**: "00:30 ORB: +1.54R, 56% days" → **CHANGE to +0.231R**
- **Line 14**: "23:00 ORB: +1.08R, 63% days" → **CHANGE to +0.387R**
- **Lines 49-74**: Night ORB section → **REWRITE with RR=1.0**
- **Lines 322-335**: Performance summary → **CORRECT night ORB values**

#### 2. TRADING_PLAYBOOK_COMPLETE.md
- **Search for**: "RR=4.0", "+1.54R", "+1.08R"
- **Replace with**: "RR=1.0", "+0.231R", "+0.387R"
- **Update**: All night ORB trade examples

#### 3. trading_app/config.py
- **Current**:
```python
"2300": {"rr": 4.0, "sl_mode": "HALF", "tier": "NIGHT"},
"0030": {"rr": 4.0, "sl_mode": "HALF", "tier": "NIGHT"},
```
- **Change to**:
```python
"2300": {"rr": 1.0, "sl_mode": "HALF", "tier": "NIGHT"},
"0030": {"rr": 1.0, "sl_mode": "HALF", "tier": "NIGHT"},
```

#### 4. trading_app/README.md
- **Search for**: "RR=4.0", "+1.54R", "+1.08R"
- **Replace with**: "RR=1.0", "+0.231R", "+0.387R"

#### 5. trading_app/APP_STATUS.md
- **Lines referencing night ORB parameters** → **CORRECT to RR=1.0**

#### 6. START_HERE_TRADING_SYSTEM.md (if exists)
- **Search for**: Night ORB RR=4.0 references
- **Replace with**: RR=1.0

#### 7. CASCADE_QUICK_REFERENCE.md, TRADING_RULESET*.md, etc.
- **Search for**: Night ORB parameters
- **Verify**: All use RR=1.0

---

## STEP 5: CANONICAL EXECUTION PIPELINE (LOCKED)

### Single Valid Data Flow

```
1. DATA SOURCE
   └─ bars_1m (DuckDB) ← from backfill_databento_continuous.py

2. FEATURE BUILDING
   └─ build_daily_features_v2.py --sl-mode half
      ├─ Entry: first 1-minute close outside ORB ✓
      ├─ Stop: HALF (midpoint) ✓
      ├─ RR: 1.0 (default) ✓
      └─ Output: daily_features_v2_half

3. DATA ACCESS
   └─ v_orb_trades_half (VIEW)
      └─ Source: daily_features_v2_half
      └─ Contains: ALL 6 ORBs with RR=1.0

4. ANALYSIS (ALLOWED)
   └─ Query v_orb_trades_half for any ORB analysis
   └─ Compare to orb_trades_5m_exec_orbr (RR=2.0) if needed
```

### Execution Rules (ENFORCED)

**VALID ENTRY METHOD** (only one allowed):
```python
# Find first close outside ORB
if close > orb_high:  # UP breakout
    entry_price = close
elif close < orb_low:  # DOWN breakout
    entry_price = close
```

**INVALID ENTRY METHOD** (forbidden):
```python
# DO NOT USE - unrealistic
entry = orb_high  # UP
entry = orb_low   # DOWN
```

**VALID STOP LOGIC**:
```python
# HALF mode (preferred)
stop = (orb_high + orb_low) / 2

# FULL mode (alternative)
stop = orb_low if direction == "UP" else orb_high
```

**VALID RR VALUES**:
- RR=1.0 (default, validated with v_orb_trades_half)
- RR=2.0 (validated with orb_trades_5m_exec_orbr, but shows negative expectancy)
- RR=4.0 (NOT VALIDATED with realistic entry - DO NOT USE)

---

## STEP 6: RUNTIME GUARDRAILS

### Add to All Remaining Backtest Scripts

```python
"""
ENTRY METHOD VALIDATION:
This script uses REALISTIC entry (first close outside ORB).

If entry is calculated at ORB edge (entry = orb_high/orb_low),
THIS SCRIPT IS INVALID and results cannot be trusted.

Entry logic: Lines XXX-YYY (verify before use)
"""
```

### Example for build_daily_features_v2.py

```python
# LINE 192: ENTRY AT CLOSE (REALISTIC)
entry_price = close  # ← CRITICAL: Entry at market close, not ORB edge

# Validate entry method
assert entry_price != orb_high, "INVALID: Entry at ORB edge"
assert entry_price != orb_low, "INVALID: Entry at ORB edge"
```

---

## EXECUTION PLAN

### Phase 1: Delete Invalid Scripts (DESTRUCTIVE)

```bash
# Move to archive folder first (safety)
mkdir -p _INVALID_SCRIPTS_ARCHIVE

# Delete primary offenders
mv backtest_all_orbs_complete.py _INVALID_SCRIPTS_ARCHIVE/
mv backtest_worst_case_execution.py _INVALID_SCRIPTS_ARCHIVE/
mv backtest_asia_prop_safe.py _INVALID_SCRIPTS_ARCHIVE/
mv backtest_asia_orbs_current.py _INVALID_SCRIPTS_ARCHIVE/
mv backtest_london_optimized.py _INVALID_SCRIPTS_ARCHIVE/
mv backtest_legacy.py _INVALID_SCRIPTS_ARCHIVE/ # if exists

# Rename invalid data file
mv complete_orb_sweep_results.csv complete_orb_sweep_results_INVALID.csv
```

### Phase 2: Fix Canonical Data

```bash
# Update canonical_session_parameters.csv
python fix_canonical_parameters.py

# Expected output:
# 2300,TRADE,1.0,HALF,BASELINE,740,48.9,202.0,0.387
# 0030,TRADE,1.0,HALF,BASELINE,740,43.5,121.0,0.231
```

### Phase 3: Update Documentation

```bash
# Update all markdown files
python update_documentation_rr.py

# Manual verification required:
# - STRATEGY_HIERARCHY_FINAL.md
# - TRADING_PLAYBOOK_COMPLETE.md
# - trading_app/config.py
# - trading_app/README.md
```

### Phase 4: Add Guardrails

```bash
# Add entry method assertions to valid scripts
python add_entry_assertions.py
```

---

## VALIDATION CHECKLIST

After cleanup, verify:

- [ ] No script uses `entry = orb_high` or `entry = orb_low`
- [ ] All backtest scripts use `entry_price = close` or equivalent
- [ ] canonical_session_parameters.csv has RR=1.0 for night ORBs
- [ ] trading_app/config.py has RR=1.0 for night ORBs
- [ ] STRATEGY_HIERARCHY_FINAL.md shows +0.231R, +0.387R (not +1.54R, +1.08R)
- [ ] complete_orb_sweep_results.csv renamed to _INVALID suffix
- [ ] All documentation references RR=1.0 for night ORBs
- [ ] v_orb_trades_half is the primary data source
- [ ] Runtime assertions added to valid scripts

---

## FINAL STATE

### Valid Scripts (KEEP)
1. build_daily_features_v2.py (primary source)
2. backtest_orb_exec_5mhalfsl_orbR.py (validated comparison)
3. backtest_orb_exec_* family (if entry = close)

### Invalid Scripts (DELETED → _INVALID_SCRIPTS_ARCHIVE/)
1. backtest_all_orbs_complete.py
2. backtest_worst_case_execution.py
3. backtest_asia_prop_safe.py
4. backtest_asia_orbs_current.py
5. backtest_london_optimized.py
6. backtest_legacy.py (if exists)

### Data Sources (VALID)
- v_orb_trades_half (PRIMARY)
- daily_features_v2_half (source table)
- orb_trades_5m_exec_orbr (RR=2.0 comparison)

### Data Sources (INVALID - Renamed)
- complete_orb_sweep_results_INVALID.csv

### Canonical Values (LOCKED)
- 23:00 ORB: RR=1.0, +0.387R avg
- 00:30 ORB: RR=1.0, +0.231R avg
- Source: v_orb_trades_half

---

## NO OPINIONS. CODE TRUTH.

All decisions based on code analysis:
- Verified entry method by reading source code
- Confirmed data lineage by checking table generation
- Validated results by comparing multiple sources
- Identified conflicts and resolved by deleting invalid sources

**When in doubt: DELETE IT.**
